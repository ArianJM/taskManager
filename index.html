<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <title>Taskmanager by ArianJM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">

  <script src="jquery-3.1.1.min.js"></script>
  <!-- Google Authorization -->
  <script src="https://apis.google.com/js/api.js" type="text/javascript"></script>
  <script src="https://apis.google.com/js/client.js"></script>
  <script type="text/javascript">
  // Your Client ID can be retrieved from your project in the Google
  // Developer Console, https://console.developers.google.com
  var clientId = '620760987090-ncpthf64vkca54210079fvlebpi2jep9.apps.googleusercontent.com';
  var apiKey = 'AIzaSyDRUtCdJkJ3ARwzSfmpVxyH_0XUxAKxX8g'
  var scope = 'https://www.googleapis.com/auth/drive.readonly';  // View the files in your Google Drive

  var signinButton = document.getElementById('signin-button');
  var signoutButton = document.getElementById('signout-button');

  function initAuth() {
    gapi.client.setApiKey(apiKey);
    gapi.auth2.init({
        client_id: clientId,
        scope: scope
    }).then(function () {
      // Listen for sign-in state changes.
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

      // Handle the initial sign-in state.
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

      signinButton.addEventListener("click", handleSigninClick);
      signoutButton.addEventListener("click", handleSignoutClick);
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      signinButton.style.display = 'none';
      signoutButton.style.display = 'block';
      getFile();
    } else {
      signinButton.style.display = 'block';
      signoutButton.style.display = 'none';
    }
  }

  function handleSigninClick(event) {
    gapi.auth2.getAuthInstance().signIn();
  }

  function handleSignoutClick(event) {
    gapi.auth2.getAuthInstance().signOut();
  }

  // Get authorization from the user to access profile info
  function handleSigninClick(event) {
    gapi.auth2.getAuthInstance().signIn().then(function() {
      makeApiCall();
    });
  }

  /**
  * Get file
  */
  function getFile(id='1SHx9uEXfIjOqvyMKN9TC1_jTjnTbogCu64VPcyuF_XM') {
    var user = gapi.auth2.getAuthInstance().currentUser.get();
    var oauthToken = user.getAuthResponse().access_token;
    var xhr = new XMLHttpRequest();
    xhr.open('GET', `https://www.googleapis.com/drive/v3/files/${id}/export?mimeType="text/csv"`);
    xhr.setRequestHeader('Authorization', 'Bearer ', oauthToken.accessToken);
    xhr.onerror = function() {
      $('#output').html('Ups: parece que se ha producido un error');
    };
    xhr.onload = function() {
      $('#output').html(`Todo bien:\n${xhr.responseText}`);
    };
    xhr.send();
  }

  gapi.load('auth2', initAuth);
  </script>
</head>

<body>
  <section class="page-header">
    <h1 class="project-name">Taskmanager</h1>
    <h2 class="project-tagline">Manages tasks</h2>
    <a href="https://github.com/ArianJM/taskManager" class="btn">View on GitHub</a>
    <a href="https://github.com/ArianJM/taskManager/zipball/master" class="btn">Download .zip</a>
    <a href="https://github.com/ArianJM/taskManager/tarball/master" class="btn">Download .tar.gz</a>
  </section>

  <section class="main-content">
    <h1><a id="taskmanager" class="anchor" href="#taskmanager" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>taskManager</h1>
    <p>Manages tasks</p>
    <div id="authorize-div" style="display: none">
      <span>Authorize access to Drive API</span>
      <!--Button for the user to click to initiate auth sequence -->
      <button id="signin-button" onclick="handleSigninClick(event)">Sign in</button>
      <button id="signout-button" onclick="handleSigninClick(event)">Sign out</button>
    </div>
    <pre id="output"></pre>

    <footer class="site-footer">
      <span class="site-footer-owner"><a href="https://github.com/ArianJM/taskManager">Taskmanager</a> is maintained by <a href="https://github.com/ArianJM">ArianJM</a>.</span>

      <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
    </footer>

  </section>


</body>
</html>
